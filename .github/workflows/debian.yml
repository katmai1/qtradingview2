name: Build and Package for Debian
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    name: Build and Package
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install Qt 6.2.1
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.2.*'
        modules: qtwebengine qtwebchannel qtpositioning
        tools: 'tools_ifw tools_qtcreator,qt.tools.qtcreator'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libgl1-mesa-dev libxkbcommon-x11-0 libxi-dev libxcursor-dev libxcomposite-dev libxdamage-dev libxrandr-dev libxtst-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libasound2-dev libdbus-1-dev

    - name: Build the application
      run: qmake && make

    - name: Create DEBIAN folder
      run: mkdir -p app/DEBIAN

    - name: Copy control file
      run: cp control app/DEBIAN/

    - name: Copy application executable
      run: cp QTradingview2 app/usr/bin/

    - name: Package for Debian
      run: fakeroot dpkg-deb --build app
      
    - name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: debian-package
        path: QTradingview2.deb/
